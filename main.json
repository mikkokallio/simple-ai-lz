{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "1190581136491841703"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "swedencentral",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "uniqueSuffix": {
      "type": "string",
      "defaultValue": "[substring(uniqueString(subscription().subscriptionId, parameters('location')), 0, 8)]",
      "minLength": 3,
      "maxLength": 8,
      "metadata": {
        "description": "Unique suffix for globally unique resource names (3-8 lowercase alphanumeric characters)"
      }
    },
    "ownerEmail": {
      "type": "string",
      "metadata": {
        "description": "Owner email for resource tagging"
      }
    },
    "entraIdTenantId": {
      "type": "string",
      "defaultValue": "[tenant().tenantId]",
      "metadata": {
        "description": "Microsoft Entra ID tenant ID for OAuth configuration"
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/16",
      "metadata": {
        "description": "VNet address prefix"
      }
    },
    "containerAppsSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/23",
      "metadata": {
        "description": "Container Apps subnet address prefix"
      }
    },
    "privateEndpointSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.2.0/24",
      "metadata": {
        "description": "Private endpoints subnet address prefix"
      }
    },
    "gatewaySubnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.3.0/27",
      "metadata": {
        "description": "Gateway subnet address prefix (for VPN Gateway)"
      }
    },
    "deployVpnGateway": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy VPN Gateway for secure developer access"
      }
    },
    "vpnClientAddressPool": {
      "type": "string",
      "defaultValue": "172.16.201.0/24",
      "metadata": {
        "description": "VPN client address pool for P2S connections"
      }
    },
    "vpnAuthType": {
      "type": "string",
      "defaultValue": "AzureAD",
      "allowedValues": [
        "AzureAD",
        "Certificate"
      ],
      "metadata": {
        "description": "VPN authentication type: AzureAD (recommended) or Certificate"
      }
    },
    "deploymentTimestamp": {
      "type": "string",
      "defaultValue": "[utcNow('yyyy-MM-dd')]",
      "metadata": {
        "description": "Deployment timestamp"
      }
    }
  },
  "variables": {
    "resourceGroupName": "rg-ailz-lab",
    "environmentName": "lab",
    "commonTags": {
      "Environment": "[variables('environmentName')]",
      "Purpose": "demo",
      "Owner": "[parameters('ownerEmail')]",
      "Project": "AI-LZ",
      "ManagedBy": "Bicep",
      "CreatedDate": "[parameters('deploymentTimestamp')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2023-07-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('commonTags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "uniqueSuffix": {
            "value": "[parameters('uniqueSuffix')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "4853466709570110968"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for resource names"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "logAnalyticsName": "[format('log-ailz-{0}', parameters('uniqueSuffix'))]",
            "appInsightsName": "[format('appi-ailz-{0}', parameters('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('logAnalyticsName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('Shared', 'true'))]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": 1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('Shared', 'true'))]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[variables('logAnalyticsName')]"
            },
            "logAnalyticsCustomerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2022-10-01').customerId]"
            },
            "applicationInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
            },
            "applicationInsightsName": {
              "type": "string",
              "value": "[variables('appInsightsName')]"
            },
            "applicationInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "applicationInsightsInstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('vnetAddressPrefix')]"
          },
          "containerAppsSubnetPrefix": {
            "value": "[parameters('containerAppsSubnetPrefix')]"
          },
          "privateEndpointSubnetPrefix": {
            "value": "[parameters('privateEndpointSubnetPrefix')]"
          },
          "gatewaySubnetPrefix": "[if(parameters('deployVpnGateway'), createObject('value', parameters('gatewaySubnetPrefix')), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9130536694859312232"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "VNet address prefix"
              }
            },
            "containerAppsSubnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "Container Apps subnet address prefix"
              }
            },
            "privateEndpointSubnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet address prefix"
              }
            },
            "gatewaySubnetPrefix": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Gateway subnet address prefix (optional, for VPN)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "vnetName": "vnet-ailz-lab",
            "containerAppsSubnetName": "snet-containerapps",
            "privateEndpointSubnetName": "snet-privateendpoints",
            "containerAppsNsgName": "nsg-containerapps",
            "privateEndpointNsgName": "nsg-privateendpoints"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-09-01",
              "name": "[variables('containerAppsNsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-HTTPS-Inbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Allow HTTPS inbound for Container Apps ingress"
                    }
                  },
                  {
                    "name": "Allow-HTTP-Inbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "80",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Allow HTTP inbound (will be redirected to HTTPS)"
                    }
                  },
                  {
                    "name": "Allow-EntraID-Outbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "AzureActiveDirectory",
                      "description": "Allow outbound to Entra ID for authentication"
                    }
                  },
                  {
                    "name": "Allow-Storage-Outbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Storage",
                      "description": "Allow outbound to Azure Storage"
                    }
                  },
                  {
                    "name": "Allow-Internet-Outbound",
                    "properties": {
                      "priority": 200,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "description": "Allow outbound internet access for container pulls and updates"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-09-01",
              "name": "[variables('privateEndpointNsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-VNet-Inbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "description": "Allow inbound from VNet to private endpoints"
                    }
                  },
                  {
                    "name": "Deny-All-Inbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Deny all other inbound traffic"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-09-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('Shared', 'true'))]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": "[concat(createArray(createObject('name', variables('containerAppsSubnetName'), 'properties', createObject('addressPrefix', parameters('containerAppsSubnetPrefix'), 'networkSecurityGroup', createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', variables('containerAppsNsgName'))), 'delegations', createArray(createObject('name', 'Microsoft.App.environments', 'properties', createObject('serviceName', 'Microsoft.App/environments'))), 'privateEndpointNetworkPolicies', 'Disabled', 'privateLinkServiceNetworkPolicies', 'Enabled')), createObject('name', variables('privateEndpointSubnetName'), 'properties', createObject('addressPrefix', parameters('privateEndpointSubnetPrefix'), 'networkSecurityGroup', createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', variables('privateEndpointNsgName'))), 'privateEndpointNetworkPolicies', 'Disabled', 'privateLinkServiceNetworkPolicies', 'Enabled'))), if(not(empty(parameters('gatewaySubnetPrefix'))), createArray(createObject('name', 'GatewaySubnet', 'properties', createObject('addressPrefix', parameters('gatewaySubnetPrefix'), 'serviceEndpoints', createArray(), 'delegations', createArray()))), createArray()))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('containerAppsNsgName'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('privateEndpointNsgName'))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[variables('vnetName')]"
            },
            "containerAppsSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-09-01').subnets[0].id]"
            },
            "containerAppsSubnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-09-01').subnets[0].name]"
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-09-01').subnets[1].id]"
            },
            "privateEndpointSubnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-09-01').subnets[1].name]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('deployVpnGateway')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "vpngateway-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "uniqueSuffix": {
            "value": "[parameters('uniqueSuffix')]"
          },
          "tenantId": {
            "value": "[tenant().tenantId]"
          },
          "vpnClientAddressPool": {
            "value": "[parameters('vpnClientAddressPool')]"
          },
          "vpnAuthType": {
            "value": "[parameters('vpnAuthType')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "8105940928943614517"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "VNet ID"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for resource names"
              }
            },
            "vpnClientAddressPool": {
              "type": "string",
              "defaultValue": "172.16.201.0/24",
              "metadata": {
                "description": "VPN client address pool for P2S connections"
              }
            },
            "vpnAuthType": {
              "type": "string",
              "defaultValue": "AzureAD",
              "allowedValues": [
                "AzureAD",
                "Certificate"
              ],
              "metadata": {
                "description": "Authentication type for P2S VPN: AzureAD (recommended) or Certificate"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD tenant ID (required for AzureAD auth, auto-populated from subscription)"
              }
            },
            "aadAudience": {
              "type": "string",
              "defaultValue": "c632b3df-fb67-4d84-bdcf-b95ad541b5c8",
              "metadata": {
                "description": "Azure AD audience - Microsoft VPN Gateway app ID (fixed value)"
              }
            }
          },
          "variables": {
            "vpnGatewayName": "[format('vpngw-ailz-{0}', parameters('uniqueSuffix'))]",
            "publicIpName": "[format('pip-vpngw-ailz-{0}', parameters('uniqueSuffix'))]",
            "loginEndpoint": "[replace(environment().authentication.loginEndpoint, 'https://', '')]",
            "aadTenant": "[format('https://{0}{1}', variables('loginEndpoint'), parameters('tenantId'))]",
            "stsHost": "[if(equals(variables('loginEndpoint'), 'login.microsoftonline.com/'), 'sts.windows.net', replace(variables('loginEndpoint'), 'login.', 'sts.'))]",
            "aadIssuer": "[format('https://{0}/{1}/', variables('stsHost'), parameters('tenantId'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-09-01",
              "name": "[variables('publicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworkGateways",
              "apiVersion": "2023-09-01",
              "name": "[variables('vpnGatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": false,
                "activeActive": false,
                "sku": {
                  "name": "VpnGw1",
                  "tier": "VpnGw1"
                },
                "ipConfigurations": [
                  {
                    "name": "default",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
                      },
                      "subnet": {
                        "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(parameters('vnetId'), '/')[8], 'GatewaySubnet')]"
                      }
                    }
                  }
                ],
                "vpnClientConfiguration": {
                  "vpnClientAddressPool": {
                    "addressPrefixes": [
                      "[parameters('vpnClientAddressPool')]"
                    ]
                  },
                  "vpnClientProtocols": [
                    "OpenVPN"
                  ],
                  "vpnAuthenticationTypes": [
                    "[parameters('vpnAuthType')]"
                  ],
                  "aadTenant": "[if(equals(parameters('vpnAuthType'), 'AzureAD'), variables('aadTenant'), null())]",
                  "aadAudience": "[if(equals(parameters('vpnAuthType'), 'AzureAD'), parameters('aadAudience'), null())]",
                  "aadIssuer": "[if(equals(parameters('vpnAuthType'), 'AzureAD'), variables('aadIssuer'), null())]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              ]
            }
          ],
          "outputs": {
            "vpnGatewayId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('vpnGatewayName'))]"
            },
            "vpnGatewayName": {
              "type": "string",
              "value": "[variables('vpnGatewayName')]"
            },
            "publicIpAddress": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2023-09-01').ipAddress]"
            },
            "gatewaySubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(parameters('vnetId'), '/')[8], 'GatewaySubnet')]"
            },
            "vpnClientAddressPool": {
              "type": "string",
              "value": "[parameters('vpnClientAddressPool')]"
            },
            "authType": {
              "type": "string",
              "value": "[parameters('vpnAuthType')]"
            },
            "setupInstructions": {
              "type": "string",
              "value": "[if(equals(parameters('vpnAuthType'), 'AzureAD'), 'VPN Gateway deployed with Azure AD (Entra ID) authentication!\r\n\r\nâœ… READY TO USE - No certificate generation needed!\r\n\r\nSTEP 1: Download Azure VPN Client for Windows\r\n   https://aka.ms/azvpnclientdownload\r\n\r\nSTEP 2: Download VPN client configuration:\r\n   \r\n   az network vnet-gateway vpn-client generate \\\r\n     --resource-group rg-ailz-lab \\\r\n     --name ${vpnGatewayName} \\\r\n     --processor-architecture Amd64\r\n\r\n   # This returns a URL - download and extract the ZIP file\r\n\r\nSTEP 3: Import configuration into Azure VPN Client\r\n   - Open Azure VPN Client\r\n   - Click \"+\" to add a connection\r\n   - Click \"Import\" and select azurevpnconfig.xml from the downloaded ZIP\r\n   - The configuration will include:\r\n     * Tenant: ${aadTenant}\r\n     * Audience: ${aadAudience}\r\n     * Issuer: ${aadIssuer}\r\n\r\nSTEP 4: Connect\r\n   - Click \"Connect\" in Azure VPN Client\r\n   - Sign in with your Microsoft/Entra ID credentials\r\n   - You''ll get an IP from the ${vpnClientAddressPool} pool\r\n\r\nSTEP 5: Test connectivity\r\n   - Once connected, you can access internal Container Apps and private endpoints\r\n   - Test with: ping <internal-container-app-fqdn>\r\n\r\nFor other platforms:\r\n- macOS/iOS: Use Azure VPN Client from App Store\r\n- Linux: Use OpenVPN with downloaded configuration\r\n- Android: Use Azure VPN Client from Play Store\r\n', 'VPN Gateway deployed with Certificate authentication.\r\n\r\nSTEP 1: Generate self-signed root certificate (PowerShell on Windows):\r\n   \r\n   $cert = New-SelfSignedCertificate -Type Custom -KeySpec Signature `\r\n     -Subject \"CN=AilzP2SRootCert\" -KeyExportPolicy Exportable `\r\n     -HashAlgorithm sha256 -KeyLength 2048 `\r\n     -CertStoreLocation \"Cert:\\\\CurrentUser\\\\My\" `\r\n     -KeyUsageProperty Sign -KeyUsage CertSign\r\n\r\nSTEP 2: Generate client certificate:\r\n   \r\n   New-SelfSignedCertificate -Type Custom -DnsName \"AilzP2SClientCert\" `\r\n     -KeySpec Signature -Subject \"CN=AilzP2SClientCert\" `\r\n     -KeyExportPolicy Exportable -HashAlgorithm sha256 -KeyLength 2048 `\r\n     -CertStoreLocation \"Cert:\\\\CurrentUser\\\\My\" `\r\n     -Signer $cert -TextExtension @(\"2.5.29.37={text}1.3.6.1.5.5.7.3.2\")\r\n\r\nSTEP 3: Export and upload root certificate:\r\n   \r\n   $rootCertBase64 = [System.Convert]::ToBase64String($cert.RawData)\r\n   $rootCertBase64 | Out-File -FilePath \"root-cert.txt\"\r\n   \r\n   az network vnet-gateway root-cert create \\\r\n     --gateway-name ${vpnGatewayName} \\\r\n     --resource-group rg-ailz-lab \\\r\n     --name AilzP2SRootCert \\\r\n     --public-cert-data \"<paste-base64-from-file>\"\r\n\r\nSTEP 4: Download VPN client and connect\r\n   \r\n   az network vnet-gateway vpn-client generate \\\r\n     --resource-group rg-ailz-lab \\\r\n     --name ${vpnGatewayName} \\\r\n     --processor-architecture Amd64\r\n')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "uniqueSuffix": {
            "value": "[parameters('uniqueSuffix')]"
          },
          "entraIdTenantId": {
            "value": "[parameters('entraIdTenantId')]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "vnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "5874595871202823893"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for resource names"
              }
            },
            "entraIdTenantId": {
              "type": "string",
              "metadata": {
                "description": "Entra ID tenant ID"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint subnet resource ID"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "VNet resource ID for private DNS zone"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "keyVaultName": "[format('kv-ailz-{0}', parameters('uniqueSuffix'))]",
            "privateEndpointName": "[format('pe-{0}', variables('keyVaultName'))]",
            "privateDnsZoneName": "privatelink.vaultcore.azure.net",
            "pvtEndpointDnsGroupName": "[format('{0}/default', variables('privateEndpointName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('Shared', 'true'))]",
              "properties": {
                "tenantId": "[parameters('entraIdTenantId')]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "enablePurgeProtection": true,
                "publicNetworkAccess": "Disabled",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Deny",
                  "ipRules": [],
                  "virtualNetworkRules": []
                }
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('privateDnsZoneName')]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneName'), format('{0}-link', variables('privateDnsZoneName')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[variables('pvtEndpointDnsGroupName')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config1",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "uniqueSuffix": {
            "value": "[parameters('uniqueSuffix')]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
          },
          "vnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1777551845445934133"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for resource names"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint subnet resource ID"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "VNet resource ID for private DNS zone"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "storageAccountName": "[format('stailz{0}', parameters('uniqueSuffix'))]",
            "privateEndpointName": "[format('pe-{0}-blob', variables('storageAccountName'))]",
            "privateDnsZoneName": "[format('privatelink.blob.{0}', environment().suffixes.storage)]",
            "pvtEndpointDnsGroupName": "[format('{0}/default', variables('privateEndpointName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('Shared', 'true'))]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": false,
                "publicNetworkAccess": "Disabled",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Deny",
                  "ipRules": [],
                  "virtualNetworkRules": []
                },
                "encryption": {
                  "services": {
                    "blob": {
                      "enabled": true,
                      "keyType": "Account"
                    },
                    "file": {
                      "enabled": true,
                      "keyType": "Account"
                    }
                  },
                  "keySource": "Microsoft.Storage"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'uploads')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'processed')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Security/defenderForStorageSettings",
              "apiVersion": "2022-12-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountName'))]",
              "name": "current",
              "properties": {
                "isEnabled": true,
                "malwareScanning": {
                  "onUpload": {
                    "isEnabled": true,
                    "capGBPerMonth": 5
                  }
                },
                "sensitiveDataDiscovery": {
                  "isEnabled": false
                },
                "overrideSubscriptionLevelSettings": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountName'))]",
              "name": "storage-diagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('privateDnsZoneName')]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneName'), format('{0}-link', variables('privateDnsZoneName')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                      "groupIds": [
                        "blob"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[variables('pvtEndpointDnsGroupName')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config1",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[variables('storageAccountName')]"
            },
            "storageAccountPrimaryEndpoints": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').primaryEndpoints]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerapps-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "uniqueSuffix": {
            "value": "[parameters('uniqueSuffix')]"
          },
          "containerAppsSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.containerAppsSubnetId.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "11333274720396100951"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for resource names"
              }
            },
            "containerAppsSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps subnet resource ID"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "environmentName": "[format('cae-ailz-{0}', parameters('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2023-05-01",
              "name": "[variables('environmentName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('Shared', 'true'))]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(parameters('logAnalyticsWorkspaceId'), '2022-10-01').customerId]",
                    "sharedKey": "[listKeys(parameters('logAnalyticsWorkspaceId'), '2022-10-01').primarySharedKey]"
                  }
                },
                "vnetConfiguration": {
                  "infrastructureSubnetId": "[parameters('containerAppsSubnetId')]",
                  "internal": true
                },
                "zoneRedundant": false,
                "workloadProfiles": [
                  {
                    "name": "Consumption",
                    "workloadProfileType": "Consumption"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "environmentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', variables('environmentName'))]"
            },
            "environmentName": {
              "type": "string",
              "value": "[variables('environmentName')]"
            },
            "defaultDomain": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', variables('environmentName')), '2023-05-01').defaultDomain]"
            },
            "staticIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', variables('environmentName')), '2023-05-01').staticIp]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    },
    "location": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "vnetId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
    },
    "vnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetName.value]"
    },
    "containerAppsSubnetId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.containerAppsSubnetId.value]"
    },
    "privateEndpointSubnetId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.privateEndpointSubnetId.value]"
    },
    "containerAppsEnvironmentId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'containerapps-deployment'), '2025-04-01').outputs.environmentId.value]"
    },
    "containerAppsDefaultDomain": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'containerapps-deployment'), '2025-04-01').outputs.defaultDomain.value]"
    },
    "containerAppsStaticIp": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'containerapps-deployment'), '2025-04-01').outputs.staticIp.value]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "storageAccountId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2025-04-01').outputs.storageAccountId.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment'), '2025-04-01').outputs.keyVaultUri.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
    },
    "applicationInsightsConnectionString": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.applicationInsightsConnectionString.value]"
    },
    "applicationInsightsInstrumentationKey": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'monitoring-deployment'), '2025-04-01').outputs.applicationInsightsInstrumentationKey.value]"
    },
    "entraIdTenantId": {
      "type": "string",
      "value": "[parameters('entraIdTenantId')]"
    },
    "vpnGatewayDeployed": {
      "type": "bool",
      "value": "[parameters('deployVpnGateway')]"
    },
    "vpnGatewayName": {
      "type": "string",
      "value": "[if(parameters('deployVpnGateway'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'vpngateway-deployment'), '2025-04-01').outputs.vpnGatewayName.value, 'Not deployed')]"
    },
    "vpnGatewayPublicIp": {
      "type": "string",
      "value": "[if(parameters('deployVpnGateway'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'vpngateway-deployment'), '2025-04-01').outputs.publicIpAddress.value, 'Not deployed')]"
    },
    "vpnSetupInstructions": {
      "type": "string",
      "value": "[if(parameters('deployVpnGateway'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'vpngateway-deployment'), '2025-04-01').outputs.setupInstructions.value, 'VPN Gateway not deployed. Set deployVpnGateway=true to enable.')]"
    }
  }
}