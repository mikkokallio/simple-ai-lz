{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "3128408617307374704"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for resources"
      }
    },
    "uniqueSuffix": {
      "type": "string",
      "defaultValue": "[uniqueString(resourceGroup().id)]",
      "metadata": {
        "description": "Unique suffix for resource names"
      }
    },
    "containerAppsEnvironmentId": {
      "type": "string",
      "metadata": {
        "description": "Container Apps Environment resource ID"
      }
    },
    "appInsightsConnectionString": {
      "type": "string",
      "metadata": {
        "description": "Application Insights connection string"
      }
    },
    "acrLoginServer": {
      "type": "string",
      "metadata": {
        "description": "Azure Container Registry login server"
      }
    },
    "acrPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Azure Container Registry password"
      }
    },
    "frontendImage": {
      "type": "string",
      "metadata": {
        "description": "Frontend container image"
      }
    },
    "backendImage": {
      "type": "string",
      "metadata": {
        "description": "Backend container image"
      }
    },
    "openAiEndpoint": {
      "type": "string",
      "metadata": {
        "description": "Azure OpenAI endpoint"
      }
    },
    "openAiDeployment": {
      "type": "string",
      "defaultValue": "gpt-4o",
      "metadata": {
        "description": "Azure OpenAI deployment name"
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage account name for blob storage"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "apiVersion": "2023-11-15",
      "name": "[format('cosmos-dayplanner-{0}', parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "kind": "GlobalDocumentDB",
      "properties": {
        "consistencyPolicy": {
          "defaultConsistencyLevel": "Session"
        },
        "locations": [
          {
            "locationName": "[parameters('location')]",
            "failoverPriority": 0,
            "isZoneRedundant": false
          }
        ],
        "databaseAccountOfferType": "Standard",
        "enableAutomaticFailover": false,
        "enableMultipleWriteLocations": false,
        "capabilities": [
          {
            "name": "EnableServerless"
          }
        ]
      }
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
      "apiVersion": "2023-11-15",
      "name": "[format('{0}/{1}', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix')), 'dayplanner-db')]",
      "properties": {
        "resource": {
          "id": "dayplanner-db"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
      "apiVersion": "2023-11-15",
      "name": "[format('{0}/{1}/{2}', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix')), 'dayplanner-db', 'itineraries')]",
      "properties": {
        "resource": {
          "id": "itineraries",
          "partitionKey": {
            "paths": [
              "/userId"
            ],
            "kind": "Hash"
          },
          "indexingPolicy": {
            "automatic": true,
            "indexingMode": "consistent",
            "includedPaths": [
              {
                "path": "/*"
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix')), 'dayplanner-db')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "Hot",
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2",
        "allowBlobPublicAccess": false
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'dayplanner-data')]",
      "properties": {
        "publicAccess": "None"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
      ]
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "environmentId": "[parameters('containerAppsEnvironmentId')]",
        "configuration": {
          "activeRevisionsMode": "Single",
          "ingress": {
            "external": true,
            "targetPort": 3000,
            "transport": "http",
            "corsPolicy": {
              "allowedOrigins": [
                "[format('https://ca-dayplanner-frontend-{0}.{1}', parameters('uniqueSuffix'), environment().suffixes.acrLoginServer)]",
                "http://localhost:5173"
              ],
              "allowedMethods": [
                "GET",
                "POST",
                "PUT",
                "DELETE",
                "OPTIONS"
              ],
              "allowedHeaders": [
                "*"
              ],
              "allowCredentials": true
            }
          },
          "registries": [
            {
              "server": "[parameters('acrLoginServer')]",
              "username": "[parameters('acrLoginServer')]",
              "passwordSecretRef": "acr-password"
            }
          ],
          "secrets": [
            {
              "name": "acr-password",
              "value": "[parameters('acrPassword')]"
            }
          ]
        },
        "template": {
          "containers": [
            {
              "name": "backend",
              "image": "[parameters('backendImage')]",
              "resources": {
                "cpu": "[json('0.5')]",
                "memory": "1Gi"
              },
              "env": [
                {
                  "name": "PORT",
                  "value": "3000"
                },
                {
                  "name": "AZURE_OPENAI_ENDPOINT",
                  "value": "[parameters('openAiEndpoint')]"
                },
                {
                  "name": "AZURE_OPENAI_DEPLOYMENT",
                  "value": "[parameters('openAiDeployment')]"
                },
                {
                  "name": "COSMOS_ENDPOINT",
                  "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix'))), '2023-11-15').documentEndpoint]"
                },
                {
                  "name": "COSMOS_DATABASE",
                  "value": "dayplanner-db"
                },
                {
                  "name": "COSMOS_CONTAINER",
                  "value": "itineraries"
                },
                {
                  "name": "STORAGE_ACCOUNT_NAME",
                  "value": "[parameters('storageAccountName')]"
                },
                {
                  "name": "STORAGE_CONTAINER",
                  "value": "dayplanner-data"
                },
                {
                  "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                  "value": "[parameters('appInsightsConnectionString')]"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": 1,
            "maxReplicas": 3
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[format('ca-dayplanner-frontend-{0}', parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "environmentId": "[parameters('containerAppsEnvironmentId')]",
        "configuration": {
          "activeRevisionsMode": "Single",
          "ingress": {
            "external": true,
            "targetPort": 80,
            "transport": "http"
          },
          "registries": [
            {
              "server": "[parameters('acrLoginServer')]",
              "username": "[parameters('acrLoginServer')]",
              "passwordSecretRef": "acr-password"
            }
          ],
          "secrets": [
            {
              "name": "acr-password",
              "value": "[parameters('acrPassword')]"
            }
          ]
        },
        "template": {
          "containers": [
            {
              "name": "frontend",
              "image": "[parameters('frontendImage')]",
              "resources": {
                "cpu": "[json('0.25')]",
                "memory": "0.5Gi"
              },
              "env": [
                {
                  "name": "VITE_API_BASE_URL",
                  "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix'))), '2024-03-01').configuration.ingress.fqdn)]"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": 1,
            "maxReplicas": 3
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
      "apiVersion": "2023-11-15",
      "name": "[format('{0}/{1}', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix')), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix'))), resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix'))), 'cosmos-contributor'))]",
      "properties": {
        "roleDefinitionId": "[format('{0}/sqlRoleDefinitions/00000000-0000-0000-0000-000000000002', resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix'))))]",
        "principalId": "[reference(resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix'))), '2024-03-01', 'full').identity.principalId]",
        "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix')))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix')))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix'))), 'blob-contributor')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
        "principalId": "[reference(resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix'))), '2024-03-01', 'full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix')))]",
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
      ]
    }
  ],
  "outputs": {
    "cosmosAccountName": {
      "type": "string",
      "value": "[format('cosmos-dayplanner-{0}', parameters('uniqueSuffix'))]"
    },
    "cosmosEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos-dayplanner-{0}', parameters('uniqueSuffix'))), '2023-11-15').documentEndpoint]"
    },
    "backendUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix'))), '2024-03-01').configuration.ingress.fqdn)]"
    },
    "frontendUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', format('ca-dayplanner-frontend-{0}', parameters('uniqueSuffix'))), '2024-03-01').configuration.ingress.fqdn)]"
    },
    "backendPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', format('ca-dayplanner-backend-{0}', parameters('uniqueSuffix'))), '2024-03-01', 'full').identity.principalId]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[parameters('storageAccountName')]"
    }
  }
}